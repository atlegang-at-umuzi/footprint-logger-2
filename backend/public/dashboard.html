<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Carbon Footprint Tracker</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .nav-bar {
            background: linear-gradient(135deg, #2d5a27 0%, #4a7c59 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .community-section {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .leaderboard {
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-rank {
            font-weight: 700;
            color: #4a7c59;
            margin-right: 15px;
        }

        .leaderboard-user {
            flex: 1;
            font-weight: 600;
        }

        .leaderboard-emissions {
            color: #dc3545;
            font-weight: 700;
        }

        .streak-display {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .community-display {
            background: linear-gradient(135deg, #4834d4 0%, #686de0 100%);
            color: white;
        }

        .weekly-summary {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .nav-bar {
                padding: 15px 20px;
            }
            
            .nav-user {
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <div class="nav-brand">üå± Carbon Tracker</div>
        <div class="nav-user">
            <span id="user-welcome">Welcome!</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </nav>

    <main class="container">
        <div class="dashboard-grid">
            <div class="stat-card">
                <div class="stat-number" id="today-emissions">0.0</div>
                <div class="stat-label">kg CO‚ÇÇ today</div>
            </div>
            
            <div class="stat-card streak-display">
                <div class="stat-number" id="user-streak">0</div>
                <div class="stat-label">day streak</div>
            </div>
            
            <div class="stat-card community-display">
                <div class="stat-number" id="community-average">0.0</div>
                <div class="stat-label">community avg</div>
            </div>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2 class="section-title">Add Activity</h2>

                <div class="form-group">
                    <label for="category">Category:</label>
                    <select id="category">
                        <option value="">Select a category</option>
                        <option value="transport">üöó Transport</option>
                        <option value="energy">‚ö° Energy</option>
                        <option value="food">üçΩÔ∏è Food</option>
                        <option value="waste">üóëÔ∏è Waste</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="activity">Activity:</label>
                    <select id="activity">
                        <option value="">Select an activity</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="amount">Amount:</label>
                    <input
                        type="number"
                        id="amount"
                        placeholder="Enter amount"
                        step="0.1"
                        min="0"
                    />
                </div>

                <button class="add-btn" onclick="addActivity()">Add Activity</button>
            </div>

            <div class="summary-section">
                <h2 class="section-title">Your Impact Summary</h2>

                <div class="total-emissions">
                    <div class="total-number" id="totalEmissions">0.0</div>
                    <div class="total-label">kg CO‚ÇÇ today</div>
                </div>

                <div class="filter-section">
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterActivities('all')">All</button>
                        <button class="filter-btn" onclick="filterActivities('transport')">Transport</button>
                        <button class="filter-btn" onclick="filterActivities('energy')">Energy</button>
                        <button class="filter-btn" onclick="filterActivities('food')">Food</button>
                        <button class="filter-btn" onclick="filterActivities('waste')">Waste</button>
                    </div>
                </div>

                <div class="activities-list" id="activitiesList">
                    <p style="text-align: center; color: #6c757d; padding: 20px">
                        No activities added yet. Start tracking your carbon footprint!
                    </p>
                </div>

                <div class="chart">
                    <div class="chart-container">
                        <div class="chart-title">Emissions by Category</div>
                        <div class="chart-bars" id="chartBars"></div>
                    </div>
                </div>

                <div class="weekly-summary">
                    <h3>This Week's Summary</h3>
                    <div id="weekly-stats">Loading...</div>
                </div>
            </div>
        </div>

        <div class="community-section">
            <h2 class="section-title">Community Leaderboard</h2>
            <p style="margin-bottom: 20px; color: #6c757d;">Top eco-friendly users (lowest emissions)</p>
            
            <div class="leaderboard" id="leaderboard">
                <div style="text-align: center; padding: 20px; color: #6c757d;">
                    Loading leaderboard...
                </div>
            </div>
        </div>
    </main>

    <script src="script.js"></script>
    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuth();
            await loadDashboardData();
            initializeApp();
        });

        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me');
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    document.getElementById('user-welcome').textContent = `Welcome, ${currentUser.username}!`;
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login';
            }
        }

        async function loadDashboardData() {
            try {
                const statsResponse = await fetch('/api/dashboard/stats');
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    
                    document.getElementById('today-emissions').textContent = stats.today.emissions.toFixed(1);
                    document.getElementById('user-streak').textContent = stats.user.streak;
                }

                const avgResponse = await fetch('/api/dashboard/community-average');
                if (avgResponse.ok) {
                    const avgData = await avgResponse.json();
                    document.getElementById('community-average').textContent = avgData.average.toFixed(1);
                }

                const leaderboardResponse = await fetch('/api/dashboard/leaderboard');
                if (leaderboardResponse.ok) {
                    const leaderboard = await leaderboardResponse.json();
                    displayLeaderboard(leaderboard);
                }

                const weeklyResponse = await fetch('/api/activities/weekly-summary');
                if (weeklyResponse.ok) {
                    const weekly = await weeklyResponse.json();
                    displayWeeklySummary(weekly);
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function displayLeaderboard(leaderboard) {
            const leaderboardEl = document.getElementById('leaderboard');
            
            if (leaderboard.length === 0) {
                leaderboardEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">No users found</div>';
                return;
            }

            const leaderboardHTML = leaderboard.map(user => `
                <div class="leaderboard-item">
                    <div>
                        <span class="leaderboard-rank">#${user.rank}</span>
                        <span class="leaderboard-user">${user.username}</span>
                    </div>
                    <div>
                        <span class="leaderboard-emissions">${user.totalEmissions} kg CO‚ÇÇ</span>
                        <span style="margin-left: 10px; color: #6c757d;">üî• ${user.streak}</span>
                    </div>
                </div>
            `).join('');

            leaderboardEl.innerHTML = leaderboardHTML;
        }

        function displayWeeklySummary(weekly) {
            const weeklyEl = document.getElementById('weekly-stats');
            
            if (weekly.activitiesCount === 0) {
                weeklyEl.innerHTML = '<p style="color: #6c757d;">No activities this week</p>';
                return;
            }

            const summaryHTML = `
                <p><strong>Total Emissions:</strong> ${weekly.totalEmissions.toFixed(2)} kg CO‚ÇÇ</p>
                <p><strong>Activities:</strong> ${weekly.activitiesCount}</p>
                <div style="margin-top: 10px;">
                    ${Object.entries(weekly.summary).map(([category, data]) => 
                        `<span style="margin-right: 15px;">${category}: ${data.emissions.toFixed(1)} kg</span>`
                    ).join('')}
                </div>
            `;

            weeklyEl.innerHTML = summaryHTML;
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/login';
            }
        }

        const originalAddActivity = addActivity;
        addActivity = async function() {
            await originalAddActivity();
            await loadDashboardData();
        };
    </script>
</body>
</html>